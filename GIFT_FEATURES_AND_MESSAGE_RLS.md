# Gift Feature Recommendations & Message Table RLS Policy Fix

## üéÅ Current Gift System Overview

### What's Already Implemented
1. **GiftDialog Component** - Beautiful gift sending modal
2. **Gift Types** - Multiple gift options with icons (stored in `gifts` table)
3. **DropToken Cost** - Each gift has a token cost (‚òï coffee, üéÇ cake, üéâ party, etc.)
4. **Gift Transactions** - Tracked in `gift_transactions` table
5. **Wallet Integration** - Users buy DropTokens from `/wallet` page
6. **Public Bio Integration** - Gift button visible on public profiles

### Current Implementation in PublicBio
```tsx
// Gift button appears below Follow button
{currentUserProfileId && currentUserProfileId !== profileId && 
 userPreferences?.store_settings?.allowGifts !== false && (
  <Button onClick={() => setShowGiftDialog(true)}>
    <Gift className="w-5 h-5" />
    Gift
  </Button>
)}

// Gift Dialog
<GiftDialog
  open={showGiftDialog}
  onOpenChange={setShowGiftDialog}
  receiverProfileId={profileId}
  senderProfileId={currentUserProfileId}
  receiverName={profile.businessName}
/>
```

---

## üéØ Recommendations to Enhance Gift Feature

### 1. **Add Gift Notifications**
When someone receives a gift:
- ‚úÖ Show notification icon in profile header
- ‚úÖ Display "Gift Received" badge with timestamp
- ‚úÖ Add notification in dashboard inbox
- ‚úÖ Send email notification to creator

### 2. **Gift History & Leaderboard**
- Display top gifters (private option)
- Show recent gifts on profile
- Track gift statistics (total gifts, favorite gift type)
- Creator dashboard showing gift breakdown

### 3. **Gift Tiers & Incentives**
- **Milestone badges**: "10 gifts received" üåü
- **Gift bonuses**: Send N gifts = reward
- **Mystery gifts**: Random high-value gift option
- **Limited edition gifts**: Seasonal or special gifts

### 4. **Gift Customization**
Add personalized message with each gift:
```tsx
// In GiftDialog, add optional message field
<textarea placeholder="Add a special message (optional)" />
```

### 5. **Creator Gift Rewards**
- Creators earn small Pi commission per gift
- Can convert gift tokens to earnings
- Gift milestone bonuses

### 6. **Social Features**
- Gift display on profile: "Last 5 gifts received"
- Share gift achievement
- Gift goals/targets

---

## üîí Message Table RLS Policy Fix

### Current Issue
The messages table has NO ROW LEVEL SECURITY policies defined. This is a security risk!

### Recommended RLS Policies

```sql
-- Enable RLS on messages table
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- 1. Senders can select their own messages
CREATE POLICY "Users can view their sent messages"
ON messages
FOR SELECT
USING (
  sender_username = (SELECT username FROM profiles WHERE user_id = auth.uid() LIMIT 1)
);

-- 2. Receivers can select messages sent to them
CREATE POLICY "Users can view messages sent to them"
ON messages
FOR SELECT
USING (
  receiver_username = (SELECT username FROM profiles WHERE user_id = auth.uid() LIMIT 1)
);

-- 3. Authenticated users can insert messages (send to anyone)
CREATE POLICY "Authenticated users can send messages"
ON messages
FOR INSERT
WITH CHECK (
  sender_username = (SELECT username FROM profiles WHERE user_id = auth.uid() LIMIT 1)
);

-- 4. Receivers can update read status
CREATE POLICY "Receivers can update message read status"
ON messages
FOR UPDATE
USING (
  receiver_username = (SELECT username FROM profiles WHERE user_id = auth.uid() LIMIT 1)
)
WITH CHECK (
  receiver_username = (SELECT username FROM profiles WHERE user_id = auth.uid() LIMIT 1)
);

-- 5. Receivers can delete their messages
CREATE POLICY "Receivers can delete their messages"
ON messages
FOR DELETE
USING (
  receiver_username = (SELECT username FROM profiles WHERE user_id = auth.uid() LIMIT 1)
);
```

### Policy Breakdown
| Policy | Action | User | Access |
|--------|--------|------|--------|
| View sent | SELECT | Sender | Own messages |
| View received | SELECT | Receiver | Messages to them |
| Send message | INSERT | Auth users | Create own messages |
| Mark read | UPDATE | Receiver | Read status only |
| Delete | DELETE | Receiver | Delete received messages |

---

## üìä Enhanced Gift Feature Architecture

### Database Schema Addition
```sql
-- Optional: Enhanced gifts table
ALTER TABLE gift_transactions ADD COLUMN IF NOT EXISTS message text;
ALTER TABLE gift_transactions ADD COLUMN IF NOT EXISTS created_at timestamptz default now();

-- Gift notifications table
CREATE TABLE IF NOT EXISTS gift_notifications (
  id bigint generated by default as identity primary key,
  receiver_profile_id uuid not null references profiles(id),
  sender_profile_id uuid not null references profiles(id),
  gift_id bigint not null references gifts(id),
  message text,
  read boolean default false,
  created_at timestamptz default now()
);

-- Gift leaderboard (materialized view)
CREATE OR REPLACE VIEW gift_leaderboard AS
SELECT 
  receiver_profile_id,
  COUNT(*) as total_gifts,
  SUM(drop_tokens_spent) as total_tokens,
  MAX(created_at) as last_gift_date
FROM gift_transactions
GROUP BY receiver_profile_id
ORDER BY total_gifts DESC;
```

---

## üöÄ Implementation Priority

### Phase 1 (High Priority - Security)
- ‚úÖ Add RLS policies to messages table
- ‚úÖ Test message permissions
- ‚úÖ Validate sender/receiver access

### Phase 2 (Medium Priority - UX)
- [ ] Add gift notifications
- [ ] Show recent gifts on profile
- [ ] Add personal message support

### Phase 3 (Low Priority - Engagement)
- [ ] Gift leaderboard
- [ ] Milestone badges
- [ ] Creator rewards

---

## üí° Public Bio Gift UI Recommendations

### Current Location
Below follow/share buttons in profile header

### Enhanced UI
```tsx
<div className="flex gap-2 flex-wrap justify-center">
  {/* Follow Button */}
  <Button onClick={handleFollow}>
    <UserPlus className="w-4 h-4 mr-2" />
    Follow
  </Button>

  {/* Share Button */}
  <Button variant="secondary" onClick={() => setShowShareDialog(true)}>
    <Share2 className="w-4 h-4 mr-2" />
    Share
  </Button>

  {/* Gift Button with Badge */}
  <Button 
    variant="outline" 
    onClick={() => setShowGiftDialog(true)}
    className="relative"
  >
    <Gift className="w-4 h-4 mr-2" />
    Gift
    {/* Optional: Show gift counter */}
    <span className="ml-2 text-xs bg-rose-500 text-white px-2 py-0.5 rounded-full">
      5
    </span>
  </Button>

  {/* Optional: Gift Stats */}
  <Button variant="ghost" size="sm">
    <GiftIcon className="w-4 h-4 mr-1" />
    {totalGiftsReceived} gifts
  </Button>
</div>
```

### Gift Display on Profile
```tsx
{/* Recently Received Gifts */}
{recentGifts && recentGifts.length > 0 && (
  <div className="mt-6 p-4 bg-rose-50 dark:bg-rose-950/20 rounded-lg border border-rose-200 dark:border-rose-800">
    <h3 className="font-semibold mb-3">Recently Received</h3>
    <div className="flex gap-2 flex-wrap">
      {recentGifts.map((tx) => (
        <div key={tx.id} className="flex items-center gap-2">
          <span className="text-2xl">{tx.gift.icon}</span>
          <div className="text-xs">
            <p className="font-medium">{tx.gift.name}</p>
            <p className="text-muted-foreground">from {tx.sender_profile.business_name}</p>
          </div>
        </div>
      ))}
    </div>
  </div>
)}
```

---

## üîê Security Checklist

- [ ] Enable RLS on messages table
- [ ] Add all 5 message RLS policies
- [ ] Test message filtering by user
- [ ] Validate senders can't read others' messages
- [ ] Validate receivers can't delete sent messages
- [ ] Enable RLS on gift_transactions table
- [ ] Restrict gift history visibility
- [ ] Validate gift balance deductions

---

## üìù Summary

### Gift System
**Status:** ‚úÖ Fully Implemented
- Users can send gifts with DropTokens
- Gift dialog with beautiful UI
- Integrated in public bio
- Transaction tracking

### Recommendations
1. Add personalized messages to gifts
2. Show gift notifications
3. Display gift history on profile
4. Add leaderboards/badges

### Message Table RLS
**Status:** ‚ö†Ô∏è NEEDS FIX
- Currently NO security policies
- Risk: Users can read all messages
- **Action Required:** Apply RLS policies below

---

## üîß Next Steps

1. Apply message table RLS policies (see SQL above)
2. Test message security
3. Consider gift notifications feature
4. Plan gift leaderboard implementation
