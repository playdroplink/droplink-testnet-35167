-- Enhanced Features: Link Shortening & AI Chat Support
-- Migration: 20251121000001_link_shortening_ai_chat.sql

-- Create shortened_links table for link shortening service
CREATE TABLE IF NOT EXISTS public.shortened_links (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    
    -- Link association
    profile_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    
    -- URL data
    original_url TEXT NOT NULL,
    short_code TEXT UNIQUE NOT NULL,
    short_url TEXT NOT NULL,
    custom_alias TEXT,
    
    -- Link metadata
    title TEXT NOT NULL DEFAULT '',
    description TEXT DEFAULT '',
    thumbnail TEXT DEFAULT '', -- Base64 encoded image
    favicon TEXT DEFAULT '', -- Base64 encoded favicon
    
    -- Display configuration
    display_style TEXT DEFAULT 'classic' CHECK (display_style IN ('classic', 'featured', 'animated')),
    custom_styling JSONB DEFAULT '{}',
    
    -- Link settings
    password_hash TEXT DEFAULT '',
    expires_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT true,
    tags TEXT[] DEFAULT '{}',
    
    -- Analytics data
    click_count INTEGER DEFAULT 0,
    unique_visitors INTEGER DEFAULT 0,
    analytics_data JSONB DEFAULT '{"countries": {}, "referrers": {}, "devices": {}, "timestamps": []}'
);

-- Create link_clicks table for detailed analytics
CREATE TABLE IF NOT EXISTS public.link_clicks (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    
    -- Link reference
    shortened_link_id UUID REFERENCES public.shortened_links(id) ON DELETE CASCADE NOT NULL,
    
    -- Click metadata
    ip_address INET,
    user_agent TEXT DEFAULT '',
    referrer TEXT DEFAULT '',
    country_code TEXT DEFAULT '',
    device_type TEXT DEFAULT '',
    browser TEXT DEFAULT '',
    
    -- Session tracking
    session_id TEXT DEFAULT '',
    is_unique_visitor BOOLEAN DEFAULT false,
    
    -- Additional data
    click_data JSONB DEFAULT '{}'
);

-- Create qr_codes table for QR code management
CREATE TABLE IF NOT EXISTS public.qr_codes (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    
    -- QR Code association
    shortened_link_id UUID REFERENCES public.shortened_links(id) ON DELETE CASCADE NOT NULL,
    profile_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    
    -- QR Code data
    qr_data TEXT NOT NULL, -- The URL or data encoded in QR
    qr_image_base64 TEXT DEFAULT '', -- Generated QR code image
    
    -- QR Code customization
    size INTEGER DEFAULT 200,
    error_correction_level TEXT DEFAULT 'M' CHECK (error_correction_level IN ('L', 'M', 'Q', 'H')),
    color_dark TEXT DEFAULT '#000000',
    color_light TEXT DEFAULT '#FFFFFF',
    logo_image TEXT DEFAULT '', -- Base64 encoded logo overlay
    
    -- QR Code settings
    include_margin BOOLEAN DEFAULT true,
    custom_design JSONB DEFAULT '{}',
    
    -- Analytics
    scan_count INTEGER DEFAULT 0,
    last_scanned_at TIMESTAMP WITH TIME ZONE
);

-- Create ai_chat_conversations table for AI chat support
CREATE TABLE IF NOT EXISTS public.ai_chat_conversations (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    
    -- Conversation association\n    profile_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,\n    session_id TEXT NOT NULL,\n    \n    -- Conversation metadata\n    visitor_ip INET,\n    user_agent TEXT DEFAULT '',\n    is_authenticated BOOLEAN DEFAULT false,\n    \n    -- Conversation status\n    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'ended', 'transferred')),\n    started_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),\n    ended_at TIMESTAMP WITH TIME ZONE,\n    \n    -- AI configuration used\n    ai_model TEXT DEFAULT 'gpt-3.5-turbo',\n    chat_config JSONB DEFAULT '{}',\n    \n    -- Conversation summary\n    message_count INTEGER DEFAULT 0,\n    satisfaction_rating INTEGER CHECK (satisfaction_rating BETWEEN 1 AND 5),\n    conversation_summary TEXT DEFAULT ''\n);\n\n-- Create ai_chat_messages table for individual messages\nCREATE TABLE IF NOT EXISTS public.ai_chat_messages (\n    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,\n    \n    -- Message association\n    conversation_id UUID REFERENCES public.ai_chat_conversations(id) ON DELETE CASCADE NOT NULL,\n    \n    -- Message data\n    content TEXT NOT NULL,\n    is_bot BOOLEAN DEFAULT false,\n    message_type TEXT DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'link', 'suggestion', 'system')),\n    \n    -- AI metadata\n    ai_confidence DECIMAL(3,2) DEFAULT 0.00 CHECK (ai_confidence BETWEEN 0 AND 1),\n    ai_model_used TEXT DEFAULT '',\n    processing_time_ms INTEGER DEFAULT 0,\n    \n    -- Message metadata\n    metadata JSONB DEFAULT '{}',\n    attachments JSONB DEFAULT '[]',\n    \n    -- Message status\n    is_edited BOOLEAN DEFAULT false,\n    edit_history JSONB DEFAULT '[]',\n    is_flagged BOOLEAN DEFAULT false\n);\n\n-- Create chatbot_designs table for AI chat customization\nCREATE TABLE IF NOT EXISTS public.chatbot_designs (\n    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,\n    \n    -- Design association\n    profile_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,\n    \n    -- Position & Size\n    position TEXT DEFAULT 'bottom-right' CHECK (position IN ('bottom-right', 'bottom-left', 'top-right', 'top-left', 'center')),\n    size TEXT DEFAULT 'medium' CHECK (size IN ('small', 'medium', 'large')),\n    \n    -- Colors\n    primary_color TEXT DEFAULT '#3b82f6',\n    secondary_color TEXT DEFAULT '#e5e7eb',\n    background_color TEXT DEFAULT '#ffffff',\n    text_color TEXT DEFAULT '#1f2937',\n    bot_message_color TEXT DEFAULT '#f3f4f6',\n    user_message_color TEXT DEFAULT '#3b82f6',\n    \n    -- Typography\n    font_family TEXT DEFAULT 'system-ui',\n    font_size INTEGER DEFAULT 14,\n    font_weight TEXT DEFAULT 'normal' CHECK (font_weight IN ('normal', 'medium', 'semibold', 'bold')),\n    \n    -- Styling\n    border_radius INTEGER DEFAULT 12,\n    shadow_style TEXT DEFAULT 'medium' CHECK (shadow_style IN ('none', 'small', 'medium', 'large')),\n    animation_style TEXT DEFAULT 'none' CHECK (animation_style IN ('none', 'pulse', 'bounce', 'glow', 'shake')),\n    \n    -- Branding\n    bot_name TEXT DEFAULT 'Assistant',\n    welcome_message TEXT DEFAULT 'Hi! How can I help you today?',\n    bot_avatar TEXT DEFAULT '', -- Base64 encoded avatar\n    show_branding BOOLEAN DEFAULT true,\n    custom_css TEXT DEFAULT '',\n    \n    -- Behavior\n    auto_open BOOLEAN DEFAULT false,\n    sound_enabled BOOLEAN DEFAULT true,\n    typing_indicator BOOLEAN DEFAULT true,\n    show_timestamps BOOLEAN DEFAULT false,\n    theme TEXT DEFAULT 'auto' CHECK (theme IN ('light', 'dark', 'auto')),\n    \n    -- Advanced settings\n    is_active BOOLEAN DEFAULT true,\n    design_version INTEGER DEFAULT 1\n);\n\n-- Create link_thumbnails table for thumbnail management\nCREATE TABLE IF NOT EXISTS public.link_thumbnails (\n    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,\n    \n    -- Thumbnail association\n    profile_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,\n    link_id UUID, -- Can be custom_link or shortened_link\n    link_type TEXT DEFAULT 'custom' CHECK (link_type IN ('custom', 'shortened')),\n    \n    -- Thumbnail data\n    image_data TEXT NOT NULL, -- Base64 encoded image\n    image_type TEXT DEFAULT 'image/png',\n    file_size INTEGER DEFAULT 0,\n    \n    -- Thumbnail metadata\n    original_filename TEXT DEFAULT '',\n    width INTEGER DEFAULT 0,\n    height INTEGER DEFAULT 0,\n    alt_text TEXT DEFAULT '',\n    \n    -- Usage tracking\n    usage_count INTEGER DEFAULT 0,\n    last_used_at TIMESTAMP WITH TIME ZONE\n);\n\n-- Add indexes for better performance\nCREATE INDEX IF NOT EXISTS idx_shortened_links_profile_id ON public.shortened_links(profile_id);\nCREATE INDEX IF NOT EXISTS idx_shortened_links_short_code ON public.shortened_links(short_code);\nCREATE INDEX IF NOT EXISTS idx_shortened_links_is_active ON public.shortened_links(is_active);\nCREATE INDEX IF NOT EXISTS idx_shortened_links_expires_at ON public.shortened_links(expires_at);\nCREATE INDEX IF NOT EXISTS idx_shortened_links_created_at ON public.shortened_links(created_at);\n\nCREATE INDEX IF NOT EXISTS idx_link_clicks_shortened_link_id ON public.link_clicks(shortened_link_id);\nCREATE INDEX IF NOT EXISTS idx_link_clicks_created_at ON public.link_clicks(created_at);\nCREATE INDEX IF NOT EXISTS idx_link_clicks_ip_address ON public.link_clicks(ip_address);\nCREATE INDEX IF NOT EXISTS idx_link_clicks_session_id ON public.link_clicks(session_id);\n\nCREATE INDEX IF NOT EXISTS idx_qr_codes_shortened_link_id ON public.qr_codes(shortened_link_id);\nCREATE INDEX IF NOT EXISTS idx_qr_codes_profile_id ON public.qr_codes(profile_id);\n\nCREATE INDEX IF NOT EXISTS idx_ai_chat_conversations_profile_id ON public.ai_chat_conversations(profile_id);\nCREATE INDEX IF NOT EXISTS idx_ai_chat_conversations_session_id ON public.ai_chat_conversations(session_id);\nCREATE INDEX IF NOT EXISTS idx_ai_chat_conversations_created_at ON public.ai_chat_conversations(created_at);\n\nCREATE INDEX IF NOT EXISTS idx_ai_chat_messages_conversation_id ON public.ai_chat_messages(conversation_id);\nCREATE INDEX IF NOT EXISTS idx_ai_chat_messages_created_at ON public.ai_chat_messages(created_at);\nCREATE INDEX IF NOT EXISTS idx_ai_chat_messages_is_bot ON public.ai_chat_messages(is_bot);\n\nCREATE INDEX IF NOT EXISTS idx_chatbot_designs_profile_id ON public.chatbot_designs(profile_id);\nCREATE INDEX IF NOT EXISTS idx_link_thumbnails_profile_id ON public.link_thumbnails(profile_id);\nCREATE INDEX IF NOT EXISTS idx_link_thumbnails_link_id ON public.link_thumbnails(link_id);\n\n-- Add updated_at triggers\nDROP TRIGGER IF EXISTS set_timestamp_shortened_links ON public.shortened_links;\nCREATE TRIGGER set_timestamp_shortened_links\n    BEFORE UPDATE ON public.shortened_links\n    FOR EACH ROW\n    EXECUTE FUNCTION trigger_set_timestamp();\n\nDROP TRIGGER IF EXISTS set_timestamp_ai_chat_conversations ON public.ai_chat_conversations;\nCREATE TRIGGER set_timestamp_ai_chat_conversations\n    BEFORE UPDATE ON public.ai_chat_conversations\n    FOR EACH ROW\n    EXECUTE FUNCTION trigger_set_timestamp();\n\nDROP TRIGGER IF EXISTS set_timestamp_chatbot_designs ON public.chatbot_designs;\nCREATE TRIGGER set_timestamp_chatbot_designs\n    BEFORE UPDATE ON public.chatbot_designs\n    FOR EACH ROW\n    EXECUTE FUNCTION trigger_set_timestamp();\n\n-- Create utility functions\n\n-- Function to generate unique short codes\nCREATE OR REPLACE FUNCTION generate_short_code()\nRETURNS TEXT AS $$\nDECLARE\n    chars TEXT := 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    result TEXT := '';\n    i INTEGER;\n    char_count INTEGER := 6;\nBEGIN\n    FOR i IN 1..char_count LOOP\n        result := result || substr(chars, (random() * length(chars))::INTEGER + 1, 1);\n    END LOOP;\n    \n    -- Ensure uniqueness\n    WHILE EXISTS(SELECT 1 FROM public.shortened_links WHERE short_code = result) LOOP\n        result := '';\n        FOR i IN 1..char_count LOOP\n            result := result || substr(chars, (random() * length(chars))::INTEGER + 1, 1);\n        END LOOP;\n    END LOOP;\n    \n    RETURN result;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Function to track link clicks\nCREATE OR REPLACE FUNCTION track_link_click(\n    p_short_code TEXT,\n    p_ip_address INET DEFAULT NULL,\n    p_user_agent TEXT DEFAULT '',\n    p_referrer TEXT DEFAULT '',\n    p_session_id TEXT DEFAULT ''\n)\nRETURNS JSONB AS $$\nDECLARE\n    v_link_id UUID;\n    v_click_id UUID;\n    v_is_unique BOOLEAN := false;\n    v_result JSONB;\nBEGIN\n    -- Get the shortened link\n    SELECT id INTO v_link_id\n    FROM public.shortened_links\n    WHERE short_code = p_short_code AND is_active = true\n    AND (expires_at IS NULL OR expires_at > NOW());\n    \n    IF v_link_id IS NULL THEN\n        RETURN jsonb_build_object(\n            'success', false,\n            'error', 'Link not found or expired'\n        );\n    END IF;\n    \n    -- Check if it's a unique visitor\n    IF NOT EXISTS (\n        SELECT 1 FROM public.link_clicks \n        WHERE shortened_link_id = v_link_id \n        AND ip_address = p_ip_address \n        AND created_at > NOW() - INTERVAL '24 hours'\n    ) THEN\n        v_is_unique := true;\n    END IF;\n    \n    -- Insert click record\n    INSERT INTO public.link_clicks (\n        shortened_link_id,\n        ip_address,\n        user_agent,\n        referrer,\n        session_id,\n        is_unique_visitor\n    ) VALUES (\n        v_link_id,\n        p_ip_address,\n        p_user_agent,\n        p_referrer,\n        p_session_id,\n        v_is_unique\n    ) RETURNING id INTO v_click_id;\n    \n    -- Update link analytics\n    UPDATE public.shortened_links\n    SET \n        click_count = click_count + 1,\n        unique_visitors = CASE WHEN v_is_unique THEN unique_visitors + 1 ELSE unique_visitors END,\n        analytics_data = analytics_data || jsonb_build_object(\n            'last_click', NOW()::text,\n            'recent_clicks', COALESCE((analytics_data->'recent_clicks')::jsonb, '[]'::jsonb) || jsonb_build_array(NOW()::text)\n        )\n    WHERE id = v_link_id;\n    \n    -- Get updated link data\n    SELECT jsonb_build_object(\n        'success', true,\n        'link_id', id,\n        'original_url', original_url,\n        'click_count', click_count,\n        'is_unique', v_is_unique\n    ) INTO v_result\n    FROM public.shortened_links\n    WHERE id = v_link_id;\n    \n    RETURN v_result;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Function to get link analytics\nCREATE OR REPLACE FUNCTION get_link_analytics(p_profile_id UUID, p_days INTEGER DEFAULT 30)\nRETURNS JSONB AS $$\nDECLARE\n    v_result JSONB;\nBEGIN\n    SELECT jsonb_build_object(\n        'total_links', COUNT(*),\n        'total_clicks', COALESCE(SUM(click_count), 0),\n        'total_unique_visitors', COALESCE(SUM(unique_visitors), 0),\n        'active_links', COUNT(*) FILTER (WHERE is_active = true),\n        'recent_activity', (\n            SELECT jsonb_agg(\n                jsonb_build_object(\n                    'date', DATE(lc.created_at),\n                    'clicks', COUNT(*)\n                )\n            )\n            FROM public.link_clicks lc\n            JOIN public.shortened_links sl ON lc.shortened_link_id = sl.id\n            WHERE sl.profile_id = p_profile_id\n            AND lc.created_at > NOW() - (p_days || ' days')::INTERVAL\n            GROUP BY DATE(lc.created_at)\n            ORDER BY DATE(lc.created_at)\n        ),\n        'top_links', (\n            SELECT jsonb_agg(\n                jsonb_build_object(\n                    'title', title,\n                    'short_code', short_code,\n                    'clicks', click_count,\n                    'unique_visitors', unique_visitors\n                )\n            )\n            FROM public.shortened_links\n            WHERE profile_id = p_profile_id\n            ORDER BY click_count DESC\n            LIMIT 10\n        )\n    ) INTO v_result\n    FROM public.shortened_links\n    WHERE profile_id = p_profile_id;\n    \n    RETURN COALESCE(v_result, '{\"total_links\": 0, \"total_clicks\": 0}'::jsonb);\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Function to clean expired links\nCREATE OR REPLACE FUNCTION cleanup_expired_links()\nRETURNS INTEGER AS $$\nDECLARE\n    v_deleted_count INTEGER;\nBEGIN\n    -- Mark expired links as inactive\n    UPDATE public.shortened_links\n    SET is_active = false\n    WHERE expires_at IS NOT NULL\n    AND expires_at < NOW()\n    AND is_active = true;\n    \n    GET DIAGNOSTICS v_deleted_count = ROW_COUNT;\n    \n    RETURN v_deleted_count;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Enable RLS on new tables\nALTER TABLE public.shortened_links ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.link_clicks ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.qr_codes ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.ai_chat_conversations ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.ai_chat_messages ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.chatbot_designs ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.link_thumbnails ENABLE ROW LEVEL SECURITY;\n\n-- Create RLS policies\n\n-- Shortened links: Public read for active links, profile owners can manage\nDROP POLICY IF EXISTS \"Public can view active shortened links\" ON public.shortened_links;\nCREATE POLICY \"Public can view active shortened links\" ON public.shortened_links\n    FOR SELECT USING (is_active = true AND (expires_at IS NULL OR expires_at > NOW()));\n\nDROP POLICY IF EXISTS \"Profile owners can manage their shortened links\" ON public.shortened_links;\nCREATE POLICY \"Profile owners can manage their shortened links\" ON public.shortened_links\n    FOR ALL USING (profile_id IN (SELECT id FROM public.profiles));\n\n-- Link clicks: Insert allowed, profile owners can view their analytics\nDROP POLICY IF EXISTS \"Anyone can track link clicks\" ON public.link_clicks;\nCREATE POLICY \"Anyone can track link clicks\" ON public.link_clicks\n    FOR INSERT WITH CHECK (true);\n\nDROP POLICY IF EXISTS \"Profile owners can view their link analytics\" ON public.link_clicks;\nCREATE POLICY \"Profile owners can view their link analytics\" ON public.link_clicks\n    FOR SELECT USING (\n        shortened_link_id IN (\n            SELECT id FROM public.shortened_links \n            WHERE profile_id IN (SELECT id FROM public.profiles)\n        )\n    );\n\n-- QR codes: Public read, profile owners can manage\nDROP POLICY IF EXISTS \"Public can view QR codes\" ON public.qr_codes;\nCREATE POLICY \"Public can view QR codes\" ON public.qr_codes\n    FOR SELECT USING (true);\n\nDROP POLICY IF EXISTS \"Profile owners can manage their QR codes\" ON public.qr_codes;\nCREATE POLICY \"Profile owners can manage their QR codes\" ON public.qr_codes\n    FOR ALL USING (profile_id IN (SELECT id FROM public.profiles));\n\n-- AI Chat: Profile owners can manage their conversations\nDROP POLICY IF EXISTS \"Profile owners can manage their AI conversations\" ON public.ai_chat_conversations;\nCREATE POLICY \"Profile owners can manage their AI conversations\" ON public.ai_chat_conversations\n    FOR ALL USING (profile_id IN (SELECT id FROM public.profiles) OR profile_id IS NULL);\n\nDROP POLICY IF EXISTS \"Users can manage AI chat messages\" ON public.ai_chat_messages;\nCREATE POLICY \"Users can manage AI chat messages\" ON public.ai_chat_messages\n    FOR ALL USING (\n        conversation_id IN (\n            SELECT id FROM public.ai_chat_conversations\n            WHERE profile_id IN (SELECT id FROM public.profiles) OR profile_id IS NULL\n        )\n    );\n\n-- Chatbot designs: Profile owners can manage\nDROP POLICY IF EXISTS \"Profile owners can manage their chatbot designs\" ON public.chatbot_designs;\nCREATE POLICY \"Profile owners can manage their chatbot designs\" ON public.chatbot_designs\n    FOR ALL USING (profile_id IN (SELECT id FROM public.profiles));\n\n-- Link thumbnails: Profile owners can manage\nDROP POLICY IF EXISTS \"Profile owners can manage their thumbnails\" ON public.link_thumbnails;\nCREATE POLICY \"Profile owners can manage their thumbnails\" ON public.link_thumbnails\n    FOR ALL USING (profile_id IN (SELECT id FROM public.profiles));\n\n-- Grant permissions\nGRANT SELECT ON public.shortened_links TO anon;\nGRANT ALL ON public.shortened_links TO authenticated;\n\nGRANT INSERT ON public.link_clicks TO anon;\nGRANT SELECT ON public.link_clicks TO authenticated;\nGRANT ALL ON public.link_clicks TO authenticated;\n\nGRANT SELECT ON public.qr_codes TO anon;\nGRANT ALL ON public.qr_codes TO authenticated;\n\nGRANT ALL ON public.ai_chat_conversations TO authenticated;\nGRANT ALL ON public.ai_chat_messages TO authenticated;\nGRANT ALL ON public.chatbot_designs TO authenticated;\nGRANT ALL ON public.link_thumbnails TO authenticated;\n\n-- Create cleanup job (for cron extension if available)\n-- SELECT cron.schedule('cleanup-expired-links', '0 2 * * *', 'SELECT cleanup_expired_links();');\n\n-- Insert default chatbot design for existing profiles\nINSERT INTO public.chatbot_designs (profile_id, bot_name, welcome_message)\nSELECT \n    id,\n    'Assistant',\n    'Hi! I\\'m here to help you with your links and any questions you might have. How can I assist you today?'\nFROM public.profiles\nWHERE NOT EXISTS (\n    SELECT 1 FROM public.chatbot_designs WHERE profile_id = profiles.id\n)\nON CONFLICT DO NOTHING;\n\n-- Refresh the schema cache\nNOTIFY pgrst, 'reload schema';\n\n-- Success message\nSELECT 'Link Shortening & AI Chat Support features added successfully!' as status;