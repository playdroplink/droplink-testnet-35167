import React, { useState, useEffect } from 'react';
import { 
  Link2, 
  Grid3X3, 
  List,
  Star,
  ArrowLeft,
  Eye,
  Plus,
  Settings,
  Palette,
  BarChart3,
  Users,
  ShoppingBag,
  Camera,
  Phone,
  Calendar,
  Type,
  Zap,
  Save,
  RefreshCw
} from 'lucide-react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { LinkLayoutManager } from './LinkLayoutManager';\nimport { PhonePreview } from './PhonePreview';\nimport { toast } from 'sonner';\n\ntype LinkDisplayType = 'stack' | 'grid' | 'carousel' | 'showcase';\ntype LinkCategory = 'suggested' | 'commerce' | 'social' | 'media' | 'contact' | 'events' | 'text';\n\ninterface CustomLink {\n  id: string;\n  title: string;\n  url: string;\n  icon?: string;\n  description?: string;\n  favicon?: string;\n  image?: string;\n  color?: string;\n  textColor?: string;\n  category: LinkCategory;\n  isVisible: boolean;\n  priority: number;\n  displayStyle: 'classic' | 'featured' | 'animated';\n  customStyling?: {\n    backgroundColor?: string;\n    borderColor?: string;\n    borderRadius?: number;\n    fontSize?: number;\n    fontWeight?: number;\n    padding?: number;\n    animation?: 'none' | 'bounce' | 'pulse' | 'glow';\n  };\n}\n\ninterface LinkTreeDashboardProps {\n  profileId?: string;\n  username?: string;\n  profileData?: any;\n  onProfileUpdate?: (data: any) => void;\n}\n\nconst LAYOUT_EXAMPLES = {\n  stack: {\n    name: \"Stack\",\n    description: \"Display links in a compact vertical list\",\n    icon: List,\n    preview: \"Compact list format, perfect for many links\",\n    bestFor: [\"Many links\", \"Clean appearance\", \"Mobile-first\"]\n  },\n  grid: {\n    name: \"Grid\",\n    description: \"Show links in a responsive grid layout\",\n    icon: Grid3X3,\n    preview: \"2-column grid, efficient use of space\",\n    bestFor: [\"Balanced layout\", \"Visual appeal\", \"Medium link count\"]\n  },\n  carousel: {\n    name: \"Carousel\",\n    description: \"Swipeable horizontal carousel of links\",\n    icon: ArrowLeft,\n    preview: \"Horizontal scrolling, interactive\",\n    bestFor: [\"Featured content\", \"Interactive experience\", \"Mobile engagement\"]\n  },\n  showcase: {\n    name: \"Showcase\",\n    description: \"Featured links with larger display\",\n    icon: Star,\n    preview: \"Large format, perfect for highlighting\",\n    bestFor: [\"Important links\", \"Premium content\", \"Strong visual impact\"]\n  }\n};\n\nexport const LinkTreeDashboard: React.FC<LinkTreeDashboardProps> = ({\n  profileId,\n  username,\n  profileData,\n  onProfileUpdate\n}) => {\n  const [customLinks, setCustomLinks] = useState<CustomLink[]>([\n    {\n      id: 'demo1',\n      title: 'My Website',\n      url: 'https://example.com',\n      icon: 'globe',\n      description: 'Visit my main website',\n      category: 'suggested',\n      isVisible: true,\n      priority: 0,\n      displayStyle: 'featured',\n      color: '#3b82f6',\n      textColor: '#ffffff'\n    },\n    {\n      id: 'demo2',\n      title: 'Instagram',\n      url: 'https://instagram.com/username',\n      icon: 'instagram',\n      description: 'Follow me on Instagram',\n      category: 'social',\n      isVisible: true,\n      priority: 1,\n      displayStyle: 'classic',\n      color: '#E4405F',\n      textColor: '#ffffff'\n    },\n    {\n      id: 'demo3',\n      title: 'Online Store',\n      url: 'https://store.example.com',\n      icon: 'shop',\n      description: 'Shop my latest products',\n      category: 'commerce',\n      isVisible: true,\n      priority: 2,\n      displayStyle: 'animated',\n      color: '#10b981',\n      textColor: '#ffffff'\n    }\n  ]);\n  \n  const [linkDisplayType, setLinkDisplayType] = useState<LinkDisplayType>('stack');\n  const [activeTab, setActiveTab] = useState('customize');\n  const [showPreview, setShowPreview] = useState(true);\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n\n  // Mock profile data for preview\n  const mockProfileData = {\n    logo: '',\n    businessName: username || 'Your Business Name',\n    storeUrl: `droplink.com/${username || 'username'}`,\n    description: 'Welcome to my link hub! Find all my important links here.',\n    youtubeVideoUrl: '',\n    socialLinks: {\n      twitter: '',\n      instagram: '',\n      youtube: '',\n      tiktok: '',\n      facebook: '',\n      linkedin: '',\n      twitch: '',\n      website: ''\n    },\n    customLinks: customLinks,\n    linkLayoutType: linkDisplayType,\n    theme: {\n      primaryColor: '#3b82f6',\n      backgroundColor: '#000000',\n      backgroundType: 'color' as const,\n      backgroundGif: '',\n      iconStyle: 'rounded',\n      buttonStyle: 'filled'\n    },\n    products: [],\n    hasPremium: true\n  };\n\n  // Handle links update\n  const handleLinksUpdate = (updatedLinks: CustomLink[]) => {\n    setCustomLinks(updatedLinks);\n    setHasUnsavedChanges(true);\n  };\n\n  // Handle display type change\n  const handleDisplayTypeChange = (type: LinkDisplayType) => {\n    setLinkDisplayType(type);\n    setHasUnsavedChanges(true);\n    toast.success(`Switched to ${LAYOUT_EXAMPLES[type].name} layout`);\n  };\n\n  // Save changes\n  const saveChanges = async () => {\n    try {\n      // In a real app, save to backend\n      const updatedProfile = {\n        ...profileData,\n        customLinks,\n        linkLayoutType: linkDisplayType\n      };\n      \n      onProfileUpdate?.(updatedProfile);\n      setHasUnsavedChanges(false);\n      toast.success('Changes saved successfully!');\n    } catch (error) {\n      console.error('Error saving:', error);\n      toast.error('Failed to save changes');\n    }\n  };\n\n  // Get category stats\n  const getCategoryStats = () => {\n    const stats: Record<LinkCategory, number> = {\n      suggested: 0,\n      commerce: 0,\n      social: 0,\n      media: 0,\n      contact: 0,\n      events: 0,\n      text: 0\n    };\n    \n    customLinks.forEach(link => {\n      if (link.isVisible) {\n        stats[link.category]++;\n      }\n    });\n    \n    return stats;\n  };\n\n  const categoryStats = getCategoryStats();\n  const totalVisibleLinks = Object.values(categoryStats).reduce((sum, count) => sum + count, 0);\n  const currentLayout = LAYOUT_EXAMPLES[linkDisplayType];\n\n  return (\n    <div className=\"w-full space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n            <Link2 className=\"w-6 h-6\" />\n            LinkTree Dashboard\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Create your personalized link hub with advanced layouts\n          </p>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          {hasUnsavedChanges && (\n            <Badge variant=\"destructive\" className=\"animate-pulse\">\n              Unsaved Changes\n            </Badge>\n          )}\n          <Button\n            onClick={() => setShowPreview(!showPreview)}\n            variant=\"outline\"\n            size=\"sm\"\n          >\n            <Eye className=\"w-4 h-4 mr-2\" />\n            {showPreview ? 'Hide' : 'Show'} Preview\n          </Button>\n          <Button\n            onClick={saveChanges}\n            disabled={!hasUnsavedChanges}\n            size=\"sm\"\n          >\n            <Save className=\"w-4 h-4 mr-2\" />\n            Save Changes\n          </Button>\n        </div>\n      </div>\n\n      {/* Quick Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center\">\n                <Link2 className=\"w-6 h-6 text-blue-600 dark:text-blue-400\" />\n              </div>\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Active Links</p>\n                <p className=\"text-2xl font-bold\">{totalVisibleLinks}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 rounded-lg bg-green-100 dark:bg-green-900/20 flex items-center justify-center\">\n                {React.createElement(currentLayout.icon, { className: \"w-6 h-6 text-green-600 dark:text-green-400\" })}\n              </div>\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Layout</p>\n                <p className=\"text-2xl font-bold\">{currentLayout.name}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 rounded-lg bg-purple-100 dark:bg-purple-900/20 flex items-center justify-center\">\n                <ShoppingBag className=\"w-6 h-6 text-purple-600 dark:text-purple-400\" />\n              </div>\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Commerce</p>\n                <p className=\"text-2xl font-bold\">{categoryStats.commerce}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 rounded-lg bg-orange-100 dark:bg-orange-900/20 flex items-center justify-center\">\n                <Users className=\"w-6 h-6 text-orange-600 dark:text-orange-400\" />\n              </div>\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Social</p>\n                <p className=\"text-2xl font-bold\">{categoryStats.social}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Main Content */}\n      <div className={`grid gap-6 ${showPreview ? 'lg:grid-cols-3' : 'grid-cols-1'}`}>\n        {/* Customization Panel */}\n        <div className={showPreview ? 'lg:col-span-2' : 'col-span-1'}>\n          <Tabs value={activeTab} onValueChange={setActiveTab}>\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"customize\">Customize Links</TabsTrigger>\n              <TabsTrigger value=\"layout\">Layout Settings</TabsTrigger>\n              <TabsTrigger value=\"analytics\">Analytics</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"customize\" className=\"space-y-6\">\n              <LinkLayoutManager\n                customLinks={customLinks}\n                onLinksUpdate={handleLinksUpdate}\n                displayType={linkDisplayType}\n                onDisplayTypeChange={handleDisplayTypeChange}\n              />\n            </TabsContent>\n\n            <TabsContent value=\"layout\" className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Palette className=\"w-5 h-5\" />\n                    Layout Comparison\n                  </CardTitle>\n                  <CardDescription>\n                    Choose the perfect layout for your links\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    {Object.entries(LAYOUT_EXAMPLES).map(([type, config]) => {\n                      const IconComponent = config.icon;\n                      const isActive = linkDisplayType === type;\n                      \n                      return (\n                        <div\n                          key={type}\n                          className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${\n                            isActive \n                              ? 'border-primary bg-primary/5' \n                              : 'border-border hover:border-muted-foreground hover:bg-muted/50'\n                          }`}\n                          onClick={() => handleDisplayTypeChange(type as LinkDisplayType)}\n                        >\n                          <div className=\"flex items-center gap-3 mb-3\">\n                            <IconComponent className={`w-6 h-6 ${\n                              isActive ? 'text-primary' : 'text-muted-foreground'\n                            }`} />\n                            <h3 className={`font-semibold ${\n                              isActive ? 'text-primary' : ''\n                            }`}>\n                              {config.name}\n                            </h3>\n                            {isActive && (\n                              <Badge variant=\"secondary\">Active</Badge>\n                            )}\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-3\">\n                            {config.description}\n                          </p>\n                          <div className=\"space-y-2\">\n                            <p className=\"text-xs font-medium text-muted-foreground\">Best for:</p>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {config.bestFor.map((item, index) => (\n                                <Badge key={index} variant=\"outline\" className=\"text-xs\">\n                                  {item}\n                                </Badge>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </CardContent>\n              </Card>\n\n              {/* Layout Settings */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Settings className=\"w-5 h-5\" />\n                    Layout Settings\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm font-medium\">Auto-arrange Links</Label>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Automatically organize links by priority\n                      </p>\n                    </div>\n                    <Switch defaultChecked />\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm font-medium\">Show Category Badges</Label>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Display category indicators on links\n                      </p>\n                    </div>\n                    <Switch defaultChecked />\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm font-medium\">Responsive Grid</Label>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Adjust grid columns based on screen size\n                      </p>\n                    </div>\n                    <Switch defaultChecked />\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"analytics\" className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <BarChart3 className=\"w-5 h-5\" />\n                    Link Performance\n                  </CardTitle>\n                  <CardDescription>\n                    Analytics for your link engagement (Premium Feature)\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-center py-12\">\n                    <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4\">\n                      <BarChart3 className=\"w-8 h-8 text-muted-foreground\" />\n                    </div>\n                    <h4 className=\"font-semibold mb-2\">Analytics Coming Soon</h4>\n                    <p className=\"text-sm text-muted-foreground mb-6\">\n                      Track click rates, visitor demographics, and link performance\n                    </p>\n                    <div className=\"space-y-3 max-w-xs mx-auto\">\n                      <div className=\"flex items-center gap-3 text-sm\">\n                        <Zap className=\"w-4 h-4 text-blue-500\" />\n                        <span>Real-time click tracking</span>\n                      </div>\n                      <div className=\"flex items-center gap-3 text-sm\">\n                        <BarChart3 className=\"w-4 h-4 text-green-500\" />\n                        <span>Detailed engagement metrics</span>\n                      </div>\n                      <div className=\"flex items-center gap-3 text-sm\">\n                        <Star className=\"w-4 h-4 text-yellow-500\" />\n                        <span>Performance optimization tips</span>\n                      </div>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n\n        {/* Mobile Preview */}\n        {showPreview && (\n          <div className=\"lg:col-span-1\">\n            <Card className=\"sticky top-6\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Eye className=\"w-5 h-5\" />\n                  Live Preview\n                </CardTitle>\n                <CardDescription>\n                  See how your links will appear to visitors\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"flex justify-center\">\n                <PhonePreview profile={mockProfileData} />\n              </CardContent>\n            </Card>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};